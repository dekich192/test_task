# Система Аутентификации и Авторизации

Этот проект представляет собой backend-приложение для аутентификации и авторизации пользователей с гибкой системой управления доступом на основе ролей (Role-Based Access Control - RBAC).

## Схема Управления Доступом

Система основана на пяти ключевых сущностях, которые хранятся в базе данных:

1.  **Users (Пользователи)**: Основная сущность, представляющая пользователя системы. У каждого пользователя может быть одна или несколько ролей.

2.  **Roles (Роли)**: Определяют набор прав. Роль — это, по сути, название для группы пользователей (например, `admin`, `editor`, `viewer`).

3.  **Resources (Ресурсы)**: Представляют собой защищаемые сущности в системе, к которым может быть ограничен доступ (например, `articles`, `user_profiles`, `billing_info`).

4.  **Permissions (Разрешения)**: Определяют конкретное действие, которое можно совершить над ресурсом (например, `create`, `read`, `update`, `delete`).

5.  **Access Rules (Правила доступа)**: Это связующее звено, которое определяет, какая **роль** имеет какое **разрешение** на какой **ресурс**. Например, правило может гласить: "Роль `editor` имеет разрешение `update` на ресурс `articles`".

### Структура таблиц в БД

-   `users`: хранит данные пользователей (email, пароль и т.д.).
-   `roles`: справочник ролей (`id`, `name`, `description`).
-   `permissions`: справочник разрешений (`id`, `name`).
-   `resources`: справочник ресурсов (`id`, `name`).
-   `user_role`: связующая таблица (многие-ко-многим) между пользователями и ролями.
-   `role_permission`: связующая таблица (многие-ко-многим) между ролями, разрешениями и ресурсами, реализующая правила доступа.

## Как это работает

1.  При регистрации пользователь по умолчанию не имеет ролей.
2.  Администратор может назначить пользователю одну или несколько ролей через API.
3.  Администратор настраивает правила доступа: например, дает роли `editor` право на `create` и `update` ресурса `articles`.
4.  Когда пользователь пытается получить доступ к защищенному эндпоинту (например, `GET /articles`), система выполняет следующие проверки:
    *   **Аутентификация (401)**: Проверяется JWT-токен. Если токен невалиден или отсутствует, возвращается ошибка 401.
    *   **Авторизация (403)**: Если пользователь аутентифицирован, система проверяет его роли и смотрит, есть ли у какой-либо из его ролей необходимое разрешение (`read`) на запрашиваемый ресурс (`articles`). Если права нет, возвращается ошибка 403.
5.  Если все проверки пройдены, пользователь получает доступ к ресурсу.

## API для управления доступом

Все эндпоинты для управления доступом требуют аутентификации и наличия у пользователя роли `admin`.

-   `POST /ac/roles`: Создать новую роль.
-   `POST /ac/users/{user_id}/roles/{role_name}`: Назначить роль пользователю.
-   `POST /ac/permissions`: Создать новое разрешение.
-   `POST /ac/resources`: Создать новый ресурс.
-   `POST /ac/roles/{role_name}/permissions`: Установить правило доступа (связать роль, разрешение и ресурс).

## Демонстрация: Mock API для "Статей"

Для демонстрации работы системы разграничения прав в проект добавлено Mock API для управления статьями (`/api/v1/articles`).

-   `GET /articles` - получить список статей (требует права `read`)
-   `POST /articles` - создать статью (требует права `create`)
-   `PUT /articles/{id}` - обновить статью (требует права `update`)
-   `DELETE /articles/{id}` - удалить статью (требует права `delete`)

### Как протестировать

Скрипт `seed.py` автоматически настраивает следующие права:
-   **Роль `admin`**: имеет полный доступ (create, read, update, delete) к статьям.
-   **Роль `user`**: имеет права на создание (`create`) и управление своими (`read_own`, `update_own`, `delete_own`) статьями.

1.  **Запустите приложение** и выполните скрипт `seed.py`.
2.  **Создайте обычного пользователя**: Зарегистрируйте нового пользователя через эндпоинт `POST /auth/register`. У него по умолчанию не будет ролей.
3.  **Войдите как администратор** (`admin@example.com`, пароль `admin123`) и получите JWT-токен.
4.  **Назначьте роль `user`** новому пользователю, используя его `user_id` и эндпоинт `POST /ac/users/{user_id}/roles/user`.
5.  **Войдите как новый пользователь** и получите его JWT-токен.
6.  **Проверьте доступ**:
    -   Попытайтесь создать статью (`POST /articles`). Запрос должен пройти успешно.
    -   Попытайтесь получить список всех статей (`GET /articles`). Запрос должен быть отклонен (статус 403), так как у пользователя нет права `read_all`.
7.  **Проверьте доступ администратора**:
    -   Войдите снова как администратор.
    -   Попробуйте создать, обновить или удалить статью. Все запросы должны пройти успешно.

